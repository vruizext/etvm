<!DOCTYPE html>
<html>
<head>

  <meta charset="UTF-8">
  <title>&gt;&gt;&gt;&nbsp;etvm</title>
  <meta name="viewport" content="width=device-width">

  <!--[if lt IE 9]>
    <script src="http://html5shiv.googlecode.com/svn/trunk/html5.js"></script>
  <![endif]-->

  <link href='http://fonts.googleapis.com/css?family=Inconsolata:400,700' rel='stylesheet' type='text/css'>
  <link href="/assets/css/style.css" rel="stylesheet" />
  <link href="/assets/css/colors-dark.css" rel="stylesheet" />

</head>

<body>

  <header id="header">
    <h1><a href="/">&gt;&gt;&gt;&nbsp;ein_teil_von_mir</a></h1>
    <!--p>&gt;&gt;&gt;&nbsp;["data mining", "R", "machine learning", "python", "and more ..."]</p-->
  </header>

  <div id="page">

    <div id="sidebar">
      <nav>
        <ul>
          <li><a href="/">Home</a></li>
          <li><a href="/archives">Archive</a></li>
          <li><a href="/about">About</a></li>
          <!--li><a href="http://github.com/vruizext">github</a></li-->
          <!--li><a href="http://linkedin.com/in/vruizext">LinkedIn</a></li-->
          <!--li><a href="/feed.xml">RSS Feed</a></li-->
        </ul>
      </nav>
    </div>

    <div id="content">
      

	<article class="post">

        <h1><a href="/2015/07/03/ranking-algorithm/">&gt;&gt;&gt; Building a ranking algorithm with Python and Redis</a></h1>
				<div class="post-content">
</div>

	</article>



	<article class="post">

        <h1><a href="/2015/07/02/pyredis-time-series/">&gt;&gt;&gt; Tracking Time Series with Python and Redis</a></h1>
				<div class="post-content">
</div>

	</article>



	<article class="post">

        <h1><a href="/2015/06/30/how-I-build-this-blog-in-one-day/">&gt;&gt;&gt; How I built this blog in one night</a></h1>
				<div class="post-content"><p>As you might have noticed, I’ve built this blog using <a href="http://jekyllrb.com/">Jekyll</a> and hosted it using
<a href="http://pages.github.com/">Github Pages</a> as blog engine. So far I think Jekyll it’s a great tool, I spent only a
few hours installing it on my laptop and customizing the <a href="http://mattvh.github.io/solar-theme-jekyll/">Solar Theme</a>,
et voilà! I have finally a blog engine which fits quite good to my needs and the best of all, open source software,
no database, no hosting costs and no dealing with the pain of customizing proprietary blog engines.</p>
</div>

	</article>



	<article class="post">

        <h1><a href="/2015/06/29/redis-counter/">&gt;&gt;&gt; Tracking counts with Python and Redis</a></h1>
				<div class="post-content"><p><a href="http://redis.io">Redis</a> is an open source, high performance key-value in memory store similar to
<a href="http://memcached.org/">memcached</a>. The two major differences between them is, first, that redis can be persisted
on disk, whereas  memcached is volatile. And second, unlike memcached and other tradicional key-value stores which only
allow to store string values associated to string keys, redis is actually a data structures server, with support for
different kind of values besides plain strings, like lists, sets, sorted sets or hashes.</p>

<p>In this post I’m going to show how to use <a href="http://redis.io/commands#sorted_set">sorted sets</a> to track counts of a list
of events (visits per page, messages sent per user, page views per day, etc) in near real time. A typical use case would
be track count of the visits of every page in a site, which could be used later to build a list of the most popular articles.
As redis is thread-safe and ensures atomicity of the commands, it can be used as well in a distributed environment, i.e.,
even when we had a cluster of web servers, we could keep all page views in only one redis counter.</p>

<p>The pages in the website will be the members, and the number of visits will be the score of every member in our sorted
set. For every page hit we simply store a page identifier and increment the number of visits. This problem could
be also solved with a hash structure, but the sorted set suits us better for this case because it’s pre-sorted, i.e. the
members are taken sorted by their score and it’s possible to retrieve a range of elements (for example, get the top 5).</p>

<h3 id="redishelper">RedisHelper</h3>
<p>I created the <code>RedisHelper</code> class (<code>redishelper.py</code>) with some functions to handle redis connections. Using a connection
pool will allow to reuse the connections in the pool rather than create a new connection every time a command is sent to
redis. The pool is created the first time a connection is requested, and maintained as a class attribute. The get_pipe
method, returns a redis pipeline which can be used to send a batch of commands which will be executed automatically.
This can dramatically improve the performance, of groups of commands, since the traffic between the client and redis
server is reduced.</p>

<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="kn">import</span> <span class="nn">redis</span>

<span class="k">class</span> <span class="nc">RedisHelper</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>

    <span class="n">server</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">set_server</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">server</span><span class="p">):</span>
        <span class="n">cls</span><span class="o">.</span><span class="n">server</span> <span class="o">=</span> <span class="n">server</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">get_pool</span><span class="p">(</span><span class="n">cls</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">pool</span> <span class="o">=</span> <span class="n">cls</span><span class="o">.</span><span class="n">pool</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="n">pool</span> <span class="o">=</span> <span class="n">redis</span><span class="o">.</span><span class="n">ConnectionPool</span><span class="p">(</span><span class="n">host</span><span class="o">=</span><span class="n">cls</span><span class="o">.</span><span class="n">server</span><span class="p">[</span><span class="s">&#39;host&#39;</span><span class="p">],</span> <span class="n">port</span><span class="o">=</span><span class="n">cls</span><span class="o">.</span><span class="n">server</span><span class="p">[</span><span class="s">&#39;port&#39;</span><span class="p">],</span> <span class="n">db</span><span class="o">=</span><span class="n">cls</span><span class="o">.</span><span class="n">server</span><span class="p">[</span><span class="s">&#39;db&#39;</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">pool</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">get_connection</span><span class="p">(</span><span class="n">cls</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">redis</span><span class="o">.</span><span class="n">Redis</span><span class="p">(</span><span class="n">connection_pool</span><span class="o">=</span><span class="n">cls</span><span class="o">.</span><span class="n">get_pool</span><span class="p">())</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">get_pipe</span><span class="p">(</span><span class="n">cls</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">cls</span><span class="o">.</span><span class="n">get_connection</span><span class="p">()</span><span class="o">.</span><span class="n">pipeline</span><span class="p">()</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">flushdb</span><span class="p">(</span><span class="n">cls</span><span class="p">):</span>
        <span class="n">cls</span><span class="o">.</span><span class="n">get_connection</span><span class="p">()</span><span class="o">.</span><span class="n">flushdb</span><span class="p">()</span></code></pre></div>
<p><br /></p>

<h3 id="rediszsetcounter">RedisZSetCounter</h3>
<p>Now let’s see the implementation of the <code>RedisZSetCounter</code> class. In the constructor, we set the config for the redis
server and for the counter. the <code>prefix</code> is intended to identify a group of counters which measures the same thing. For
every counter in a group we’ll have a <code>counter_id</code>. For example, if we might create a group of counters to measure page hits
per day, the keys would have the following format: <code>hits:21-06-2015</code>, <code>hits:22-06-2015</code>, etc., where ‘hits’ would be the
<code>prefix</code>, and the date would be the <code>counter_id</code>.</p>

<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="k">class</span> <span class="nc">RedisZSetCounter</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Counter that uses redis to store data</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">server</span><span class="p">,</span> <span class="n">config</span><span class="p">):</span>
        <span class="n">RedisHelper</span><span class="o">.</span><span class="n">set_server</span><span class="p">(</span><span class="n">server</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">redis</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">prefix</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s">&#39;prefix&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ttl</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s">&#39;ttl&#39;</span><span class="p">]</span></code></pre></div>
<p><br /></p>

<p>The keys for every counter are built concatenating the prefix and the counter identifier.</p>

<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="k">def</span> <span class="nf">get_key</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">counter_id</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        build the key that identifies a counter</span>
<span class="sd">        :return: counter key (string)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="s">&quot;</span><span class="si">%s</span><span class="s">:</span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">prefix</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">counter_id</span><span class="p">))</span></code></pre></div>
<p><br /></p>

<p>Using the <code>RedisHelper</code> class we get a redis connection.</p>

<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="k">def</span> <span class="nf">get_redis</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get redis connection, lazy loading</span>
<span class="sd">        :return: redis object</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">redis</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">redis</span> <span class="o">=</span> <span class="n">RedisHelper</span><span class="o">.</span><span class="n">get_connection</span><span class="p">()</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">redis</span></code></pre></div>
<p><br /></p>

<p>To increase the count of an entry, we use redis <code>zincrby</code> command. By default, we increase the score by one, but it’s
possible to pass an arbitrary value.</p>

<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="k">def</span> <span class="nf">incr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">counter_id</span><span class="p">,</span> <span class="n">entry</span><span class="p">,</span> <span class="n">count</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Increments the count of member_id in the current bucket by count</span>
<span class="sd">        Supports decreasing, when count &lt; 0</span>
<span class="sd">        :param counter_id:  identifier for this counter</span>
<span class="sd">        :param entry: identifier of the member / item / whatever is being accounted</span>
<span class="sd">        :param count: increase count by this amount</span>
<span class="sd">        :return: the new count for this entry</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">key</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_key</span><span class="p">(</span><span class="n">counter_id</span><span class="p">)</span>
        <span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_redis</span><span class="p">()</span><span class="o">.</span><span class="n">zincrby</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">entry</span><span class="p">,</span> <span class="n">count</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">get_redis</span><span class="p">()</span><span class="o">.</span><span class="n">expires</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ttl</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">value</span></code></pre></div>
<p><br /></p>

<p>It’s also possible to pass a negative value to <code>zincrby</code>. In that case, the score is decreased by the specified amount.</p>

<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="k">def</span> <span class="nf">decr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">counter_id</span><span class="p">,</span> <span class="n">entry</span><span class="p">,</span> <span class="n">count</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Decrease counter, by calling incr with negative count</span>
<span class="sd">        :param counter_id: suffix identifier for this counter</span>
<span class="sd">        :param entry: identifier of the member / item / whatever is being accounted</span>
<span class="sd">        :param count: decrease count by this amount</span>
<span class="sd">        :return: the new count of the entry</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">incr</span><span class="p">(</span><span class="n">counter_id</span><span class="p">,</span> <span class="n">entry</span><span class="p">,</span> <span class="o">-</span><span class="n">count</span><span class="p">)</span></code></pre></div>
<p><br /></p>

<p>The last N items can be retrieved using <code>zrange</code>. We need to specify the parameter <code>desc=False</code>, because we don’t want
the entries in descending order but in increasing. Since dictionaries in python don’t preserve the order of the keys, we
are using a list of tuples to handle the key-values returned by the counter.</p>

<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="k">def</span> <span class="nf">last_n</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">counter_id</span><span class="p">,</span> <span class="n">how_many</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        get the last N entries in this counter</span>
<span class="sd">        :param counter_id: identifier for this counter</span>
<span class="sd">        :param how_many: how many items to return (top N)</span>
<span class="sd">        :return: list of tuples (id, count)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">key</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_key</span><span class="p">(</span><span class="n">counter_id</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_redis</span><span class="p">()</span><span class="o">.</span><span class="n">zrange</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">how_many</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">withscores</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span></code></pre></div>
<p><br /></p>

<p>Using <code>zrevrange</code> command, we retrieve the top N items with highest score. Note that <code>zrange</code> with <code>desc=True</code> would
also do the job here.</p>

<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="k">def</span> <span class="nf">top_n</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">counter_id</span><span class="p">,</span> <span class="n">how_many</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        get the top N entries in the counter</span>
<span class="sd">        :param counter_id: identifier for this counter</span>
<span class="sd">        :param how_many: how many items to return (top N)</span>
<span class="sd">        :return: list of tuples (id, count)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">key</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_key</span><span class="p">(</span><span class="n">counter_id</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_redis</span><span class="p">()</span><span class="o">.</span><span class="n">zrevrange</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">how_many</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">withscores</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span></code></pre></div>
<p><br /></p>

<h3 id="how-to-use-it">How to use it</h3>

<p>Finally, let’s see with an example how to use <code>RedisZSetCounter</code></p>

<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="kn">from</span> <span class="nn">redishelper</span> <span class="kn">import</span> <span class="n">RedisHelper</span>
    <span class="kn">from</span> <span class="nn">redisZcounter</span> <span class="kn">import</span> <span class="n">RedisZSetCounter</span>

    <span class="n">redis_server</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;host&#39;</span><span class="p">:</span> <span class="s">&#39;localhost&#39;</span><span class="p">,</span> <span class="s">&#39;port&#39;</span><span class="p">:</span> <span class="mi">6379</span><span class="p">,</span> <span class="s">&#39;db&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">}</span>
    <span class="n">params</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;prefix&#39;</span><span class="p">:</span> <span class="s">&quot;hits&quot;</span><span class="p">,</span> <span class="s">&#39;ttl&#39;</span><span class="p">:</span> <span class="mi">120</span><span class="p">}</span>
    <span class="n">zcount</span> <span class="o">=</span> <span class="n">RedisZSetCounter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">redis_server</span><span class="p">,</span> <span class="n">params</span><span class="p">)</span>
    <span class="n">RedisHelper</span><span class="o">.</span><span class="n">redis_flushdb</span><span class="p">()</span>
    <span class="n">zcount</span><span class="o">.</span><span class="n">incr</span><span class="p">(</span><span class="s">&#39;test_id&#39;</span><span class="p">,</span> <span class="s">&#39;page_1&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">zcount</span><span class="o">.</span><span class="n">incr</span><span class="p">(</span><span class="s">&#39;test_id&#39;</span><span class="p">,</span> <span class="s">&#39;page_2&#39;</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
    <span class="n">zcount</span><span class="o">.</span><span class="n">incr</span><span class="p">(</span><span class="s">&#39;test_id&#39;</span><span class="p">,</span> <span class="s">&#39;page_3&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

    <span class="n">best</span> <span class="o">=</span> <span class="n">zcount</span><span class="o">.</span><span class="n">top_n</span><span class="p">(</span><span class="s">&#39;test_id&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="c"># best =&gt; (&#39;page_2&#39;, 3)</span></code></pre></div>
<p><br /></p>

<h3 id="wrapping-up">Wrapping up</h3>

<p>Even though the use case presented in this post is very simple, we can see some of the advantages of using a noSQL database as
redis over a relational database to do real-time state management. Besides the simplicity and the performance, it’s the power
 of its data structures. In my next posts I will extend the functionality of this counter and show how to use it to track
 event counts with time series.</p>

<p>For those who are lazy to type, you can find the code in my github <a href="https://github.com/vruizext/RedisZCounter">repository</a>.
To run the code if you haven’t yet, you’ll need to install redis server and the redis client for <a href="https://github.com/andymccurdy/redis-py">python</a>.</p>

</div>

	</article>



	<article class="post">

        <h1><a href="/2015/06/28/hello-world/">&gt;&gt;&gt; print "Hello World!"</a></h1>
				<div class="post-content"><p>Hello World!</p>

<p>I hope this is the start of a long lasting blogging adventure, where I will be writing about some of the projects I have worked on the last years and also about the new ones that are still to come. About the topics you can expect to find here, as you can read in the header, mostly Data Mining, Machine Learning, Python, R, but not limited to only this.</p>

<p>The title ‘Ein teil von mir’, which was inspired originally by the text of a <a href="http://www.youtube.com/watch?v=UwQfDTkLmfA">Berlin techno anthem</a>, means ‘A part of me’. And that is exactly the goal I had in mind when I decided to start this blog, sharing a part of me with the world. I hope the knowledge I will share here is somehow helpful for some of you and also that many others of you enjoy reading and learning some stuff.</p>

<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="k">def</span> <span class="nf">print_bye</span><span class="p">(</span><span class="nb">str</span><span class="p">):</span>
  <span class="k">print</span> <span class="s">&quot;See you soon </span><span class="si">%s</span><span class="s">!&quot;</span> <span class="o">%</span> <span class="nb">str</span>

<span class="n">print_bye</span><span class="p">(</span><span class="s">&#39;World&#39;</span><span class="p">)</span>
<span class="c">#=&gt; prints &#39;See you soon World!&#39; to STDOUT.</span></code></pre></div>

</div>

	</article>







    </div>

  </div>

  <footer id="footer">
    <p style="text-align:center"><a class="logo" href="http://github.com/vruizext"><img src="/images/github.png"/></a>&nbsp;&nbsp;<a class="logo" href="http://linkedin.com/in/vruizext"><img src="/images/linkedin.png"/></a></p>
    <p class="copyright" style="text-align:center">Copyright &copy; 2015 ein_teil_von_mir. Powered by <a href="http://jekyllrb.com">Jekyll</a></p>
  </footer>

  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.10.1/jquery.min.js"></script>
  <script src="/assets/js/jquery.mobilemenu.min.js"></script>

  <script>
    $(document).ready(function(){
      $('#sidebar nav ul').mobileMenu({'topOptionText': 'Menu', 'prependTo': '#sidebar nav'});
    });
  </script>

</body>
</html>
